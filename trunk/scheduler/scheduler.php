<?php
 //FILE SCHEDULED FOR DELETION
$pos = (strpos($_SERVER['PHP_SELF'], "/mysqlt-common.php"));
if ($pos !== false)
{
    die("You cannot access this page directly!");
}
require_once("config.php");
require_once("global_funcs.php");
connectdb();
$starttime = time();
$res = $db->Execute("UPDATE $dbtables[products] SET amount = 0 WHERE amount < 0");
db_op_result($res,__LINE__,__FILE__);
$res = $db->Execute("OPTIMIZE TABLE $dbtables[chiefs] ,"
            ." $dbtables[clans],"
            //." $dbtables[elements],"
            ." $dbtables[game_date],"
            ." $dbtables[hexes],"
            ." $dbtables[livestock],"
            ." $dbtables[logs],"
            ." $dbtables[map_table],"
            ." $dbtables[movement_log],"
            ." $dbtables[products],"
            ." $dbtables[resources],"
            ." $dbtables[skills],"
            ." $dbtables[tribes],"
            ." $dbtables[last_turn],"
            ." $dbtables[activities],"
            ." $dbtables[scouts],"
            ." $dbtables[weather]");

db_op_result($res,__LINE__,__FILE__);
//////////////////////////////////Undo the Transfers table//////////////////////////////

$res = $db->Execute("TRUNCATE table $dbtables[poptrans]");
db_op_result($res,__LINE__,__FILE__);

/////////////////////////////////Establish Game Time//////////////////////////////////////////
include("game_time.php");
///////////////////////////////////DeVA Determination///////////////////////////////////////////
include("deva.php");
//////////////////////////////Goods Tribe Determination//////////////////////////////////////////////
include("goods_tribe.php");
/////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////Get rid of abandoned structures/////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
include("structures.php");
/////////////////////////////////// Primary Skill Attempts /////////////////////////////////////////////////////////
include("primaryskill.php");
//////////////////////////////////////// Secondary Skill Attempts ////////////////////////////////////////////////////
include("secondaryskill.php");
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////5 + //////////Activities////////////////////////////////////////////////////////////
///////////////////////////////////Get rid of the last turn's activities////////////////////////////

$res = $db->Execute("TRUNCATE $dbtables[last_turn]");
db_op_result($res,__LINE__,__FILE__);
///////////////////////////////////Copy this turn's into last_turn//////////////////////////////
///////////////////////////Not including defaults added by the game////////////////////////////

$last = $db->Execute("SELECT * FROM $dbtables[activities]");
db_op_result($last,__LINE__,__FILE__);
while( !$last->EOF )
{
    $last_turn = $last->fields;
    $res = $db->Execute("INSERT INTO $dbtables[last_turn] "
                ."VALUES("
                ."'',"
                ."'$last_turn[tribeid]',"
                ."'$last_turn[skill_abbr]',"
                ."'$last_turn[product]',"
                ."'$last_turn[actives]')");
    db_op_result($res,__LINE__,__FILE__);
    $last->MoveNext();
}
////////////////////////////Default Activities////////////////////////////////////////////////////
include("defaultactivities.php");
////////////////////////////////////////End of default///////////////////////////////////////////////
////////////////////////////////////////////////////Fair Code///////////////////////////////////////////////
///////////////////////////////////////Culture Transactions////////////////////////////////////////////////
if( $month[count] == '4' || $month[count] == '10' )
{
    include("fairfigures.php");
}
/////////////////////////////////////////////////Fair Price Adjustment//////////////////////////////////////////////////
if( $month[count] == '5' || $month[count] == '11' )
{
    include("fairfigures2.php");
}
/////////////////////////////////////////////////Fair Price List//////////////////////////////////////////////////////
if( $month[count] == '6' || $month[count] == '12' )
{
    include("fairpricelist.php");
}
////////////////////////////////////////////Mining////////////////////////////////////////////////////////////
include("mining.php");
///////////////////////////////////////////Quarrying/////////////////////////////////////////////
include("quarry.php");
///////////////////////////////////////Testing out the combo of hunt/fur/////////////////////////////////
include("huntfur.php");
//////////////////////////////////////Skin, Gut, Bone////////////////////////////////////////////////////
include("skingutbone.php");
////////////////////////////////////////////////BoneWork/////////////////////////////////////////////////
include("bonework.php");
////////////////////////////////////////////////Forestry/////////////////////////////////////////////////
include("forestry.php");
//////////////////////////////////////////////////Tanning////////////////////////////////////////////////
include("tanning.php");
//////////////////////////////////////////////////Curing///////////////////////////////////////////////////
include("curing.php");
/////////////////////////////////////////////////Dressing/////////////////////////////////////////////////
include("dressing.php");
/////////////////////////////////////////////////Armor Making//////////////////////////////////////////////
include("armormaking.php");
/////////////////////////////////////////////////Leatherworking/////////////////////////////////////////////
include("leatherworking.php");

//////////////////////////////////////////////////Weaving///////////////////////////////////////////////////
include("weaving.php");
///////////////////////////////////////////////////Sewing/////////////////////////////////////////////////
include("sewing.php");
//////////////////////////////////////////////////Waxworking////////////////////////////////////////////////
include("waxwork.php");
//////////////////////////////////////////////////Woodworking//////////////////////////////////////////////
include("woodworking.php");
///////////////////////////////////////////////////Metalworking//////////////////////////////////////////////////////////////
include("metalworking.php");
///////////////////////////////////////////////WeaponMaking////////////////////////////////////////////////////////////////
include("weaponmaking.php");
////////////////////////////////////////////////Seige Equipment/////////////////////////////////////////////////////////
include("hvywpns.php");
/////////////////////////////////////////////////Stonework////////////////////////////////////////////////////////////////
include("stonework.php");
///////////////////////////////////////////////////Herding//////////////////////////////////////////////////////////////////
include("herding.php");
///////////////////////////////////////////////////Refining/////////////////////////////////////////////////////////////////
include("refining.php");
////////////////////////////////////////////////////Engineering//////////////////////////////////////////////////////////////
include("engineering.php");
////////////////////////////////////////////////Farming///////////////////////////////////////////////////////////////////
include("farming.php");
include("farmgrowth.php");
////////////////////////////////////////////////Apiarism//////////////////////////////////////////////////////
include("apiarism.php");
////////////////////////////////////////////////Distilling//////////////////////////////////////////////////
include("distilling.php");
////////////////////////////////////////////////Baking///////////////////////////////////////////////////////
include("baking.php");
///////////////////////////////////////////////Fletching///////////////////////////////////////////////////
include("fletching.php");
////////////////////////////////////////////////Seeking/////////////////////////////////////////////////////////////
include("seeking.php");

////////////////////////////////////////////Population///////////////////////////////////////////////////
include("population.php");
////////////////////Update Garrison Experience///////////////////////////////////////////////
include("garexp.php");
///////////////////////////////////////////////Do scouting/////////////////////////////////////////
include("scouting.php");
//////////////////////////////////////////////////Generate Scores For the Month/////////////////////////////////////////////////////////
include("scores.php");
//////////////////////////////////////////////////Move everything to the goods tribes///////////////////////////////////////
include("gttransfers.php");
include("weight.php");
//////////////////////////////////////////////////Hex Game Repopulation///////////////////////////////////////////////////
include("hexupdate.php");
////////////////////////////////////////////////////Give back products used in activities/////////////////////////////////
include("productgiveback.php");
//////////////////////////////////////////////////Clean Up any dead subtribes///////////////////////////////////////////////
include("cleanup.php");
///////////////////////////////////////////////////Reset Poptransfer table///////////////////////////////////////////////////
$res = $db->Execute("DELETE FROM $dbtables[poptrans]");
db_op_result($res,__LINE__,__FILE__);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$res = $db->Execute("DELETE FROM $dbtables[activities] WHERE skill_abbr = 'Relax'");
db_op_result($res,__LINE__,__FILE__);
$res = $db->Execute("UPDATE $dbtables[chiefs] SET active = active + 1");
db_op_result($res,__LINE__,__FILE__);
$res = $db->Execute("DELETE FROM $dbtables[map_view]");
db_op_result($res,__LINE__,__FILE__);
$weather = $db->Execute("SELECT * FROM $dbtables[game_date] where type = 'weather'");
db_op_result($weather,__LINE__,__FILE__);
$weatherinfo = $weather->fields;
$res = $db->Execute("UPDATE $dbtables[game_date] set count = 0 WHERE type = 'weather'");
db_op_result($res,__LINE__,__FILE__);
$res = $db->Execute("UPDATE $dbtables[structures] SET used = 'N' WHERE used = 'Y'");
db_op_result($res,__LINE__,__FILE__);
$time_update = $db->Execute("SELECT * FROM $dbtables[game_date] where type='month'");
db_op_result($time_update,__LINE__,__FILE__);
$data = $time_update->fields;
if($data['count'] == 12)
{
   $newmonth = 1;
   $years = $db->Execute("select count from $dbtables[game_date] where type='year'");
   db_op_result($years,__LINE__,__FILE__);
   $yearinfo = $years->fields;
   $newyear = $yearinfo['count'] + 1;
}
else
{
   $newmonth = $data['count'] + 1;
}

$gameupdate = $db->Execute("UPDATE $dbtables[game_date] SET count=1 where type='day'");
db_op_result($gameupdate,__LINE__,__FILE__);
$gameupdate = $db->Execute("UPDATE $dbtables[game_date] SET count=$newmonth where type='month'");
db_op_result($gameupdate,__LINE__,__FILE__);
if($newmonth == 1)
{
    $gameupdate = $db->Execute("UPDATE $dbtables[game_date] SET count=$newyear where type='year'");
    db_op_result($gameupdate,__LINE__,__FILE__);
}

$endtime = time();
$diff_seconds = $endtime - $starttime;
$diff_minutes = floor($diff_seconds/60);
$diff_seconds -= $diff_minutes * 60;

$result = $db->Execute("INSERT INTO $dbtables[logs] "
            ."VALUES("
            ."'',"
            ."'$month[count]',"
            ."'$year[count]',"
            ."'0000',"
            ."'0000',"
            ."'SYSTEMSTAT',"
            ."'$stamp',"
            ."'Update completed in $diff_minutes minutes, "
            ."$diff_seconds seconds, the weather count "
            ."reached $weatherinfo[count]')");

db_op_result($result,__LINE__,__FILE__);

?>
